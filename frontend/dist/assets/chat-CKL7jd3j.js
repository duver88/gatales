import{G as Z,r,q as J,H as d,u as j,B as W}from"./index-DdZd5_5M.js";const ne=Z("conversations",()=>{const e=r([]),g=r({}),i=r(null),v=r(!1),C=r(!1),T=r(""),w=r([]),b=r(!1);let x=null,D=0;const P=6e4,O=J(()=>e.value.find(s=>s.id===i.value)),L=J(()=>e.value.length>0);async function N(s=!1){const a=Date.now();return!s&&e.value.length>0&&a-D<P?{conversations:e.value,grouped:g.value}:x||(v.value=!0,x=(async()=>{try{const l=await d.getConversations();return e.value=l.data.conversations||[],g.value=l.data.grouped||{},D=Date.now(),l.data}catch(l){throw console.error("Error fetching conversations:",l),l}finally{v.value=!1,x=null}})(),x)}async function h(){C.value=!0;try{const a=(await d.createConversation()).data.conversation;return e.value.unshift(a),i.value=a.id,g.value.today||(g.value.today={title:"Hoy",conversations:[]}),g.value.today.conversations.unshift(a),a}catch(s){throw console.error("Error creating conversation:",s),s}finally{C.value=!1}}async function E(s){i.value=s}async function $(s,a){try{await d.updateConversation(s,{title:a});const l=e.value.find(I=>I.id===s);l&&(l.title=a)}catch(l){throw console.error("Error updating conversation title:",l),l}}async function B(s){try{await d.deleteConversation(s),e.value=e.value.filter(a=>a.id!==s);for(const a in g.value){const l=g.value[a];l.conversations&&(l.conversations=l.conversations.filter(I=>I.id!==s))}i.value===s&&(i.value=e.value[0]?.id||null)}catch(a){throw console.error("Error deleting conversation:",a),a}}async function G(s){try{await d.archiveConversation(s),e.value=e.value.filter(a=>a.id!==s);for(const a in g.value){const l=g.value[a];l.conversations&&(l.conversations=l.conversations.filter(I=>I.id!==s))}i.value===s&&(i.value=e.value[0]?.id||null)}catch(a){throw console.error("Error archiving conversation:",a),a}}async function Q(s){if(!s||s.length<2){w.value=[];return}b.value=!0,T.value=s;try{const a=await d.searchConversations(s);w.value=a.data.conversations||[]}catch(a){console.error("Error searching conversations:",a),w.value=[]}finally{b.value=!1}}function k(){T.value="",w.value=[]}function _(s,a){const l=e.value.find(I=>I.id===s);l&&Object.assign(l,a);for(const I in g.value){const H=g.value[I];if(H.conversations){const R=H.conversations.find(z=>z.id===s);if(R){Object.assign(R,a);break}}}}function m(){e.value=[],g.value={},i.value=null,T.value="",w.value=[],D=0}return{conversations:e,groupedConversations:g,currentConversationId:i,currentConversation:O,isLoading:v,isCreating:C,searchQuery:T,searchResults:w,isSearching:b,hasConversations:L,fetchConversations:N,createConversation:h,selectConversation:E,updateConversationTitle:$,deleteConversation:B,archiveConversation:G,searchConversations:Q,clearSearch:k,updateConversationLocally:_,reset:m}}),X={"gpt-5.2":{input:5,output:15},"gpt-5.2-mini":{input:.3,output:1.2},"gpt-5.2-codex":{input:3,output:12},"gpt-5.1":{input:4,output:12},"gpt-5.1-mini":{input:.25,output:1},"gpt-5.1-codex":{input:2.5,output:10},"gpt-5":{input:3,output:10},"gpt-5-mini":{input:.2,output:.8},"gpt-4o":{input:2.5,output:10},"gpt-4o-mini":{input:.15,output:.6},"gpt-4-turbo":{input:10,output:30},"gpt-4":{input:30,output:60},"gpt-3.5-turbo":{input:.5,output:1.5},o1:{input:15,output:60},"o1-mini":{input:3,output:12},"deepseek-chat":{input:.14,output:.28},"deepseek-reasoner":{input:.55,output:2.19}};function Y(e,g,i){const v=X[e]||X["gpt-4o-mini"],C=g/1e6*v.input,T=i/1e6*v.output;return C+T}let se=0;function U(e="temp"){return`${e}_${Date.now()}_${++se}_${Math.random().toString(36).substr(2,9)}`}const le=Z("chat",()=>{const e=r([]),g=r(!1),i=r(!1),v=r(null),C=r(!1),T=r(null),w=r(!1),b=r(null),x=r(null),D=r([]),P=r(!1);let O=null,L=0;const N=3e5,h=r(null),E=r(null),$=J(()=>e.value.length>0);async function B(n=null){g.value=!0,v.value=null;try{let t;n?(t=await d.getConversationMessages(n),h.value=n,E.value=t.data.conversation):(t=await d.getMessages(),t.data.conversation_id&&(h.value=t.data.conversation_id)),e.value=t.data.messages;const c=[...t.data.messages].reverse().find(u=>u.role==="user");return c&&(s.value=c.content),t.data.assistant&&(x.value=t.data.assistant),j().updateTokensBalance(t.data.tokens_balance),t.data}catch(t){throw v.value=t.response?.data?.message||"Error al cargar los mensajes",t}finally{g.value=!1}}async function G(n=!1){const t=Date.now();return!n&&D.value.length>0&&t-L<N?{assistants:D.value}:O||(O=(async()=>{try{const c=await d.getAvailableAssistants();return D.value=c.data.assistants,L=Date.now(),c.data}catch(c){throw console.error("Error fetching assistants:",c),c}finally{O=null}})(),O)}async function Q(n){P.value=!0,v.value=null;try{const t=await d.changeMyAssistant(n);return x.value=t.data.assistant,e.value=[],t.data}catch(t){throw v.value=t.response?.data?.message||"Error al cambiar asistente",t}finally{P.value=!1}}const k=r(""),_=r(!1),m=r(!1),s=r(""),a=r(null),l=r({input:0,output:0,model:null,cost:0});function I(){const n=d.stopStream();if(n){_.value=!1,m.value=!1,i.value=!1;const t=e.value.find(c=>c.isStreaming);t&&(t.isStreaming=!1,t.isThinking=!1,t.isStopped=!0,t.content=k.value||"",a.value=t.id)}return n}async function H(){if(!s.value||i.value)return;const n=e.value.findIndex(c=>c.isFailed||c.isStopped||c.id===a.value);n!==-1&&e.value.splice(n,1);const t=e.value.length-1;return t>=0&&e.value[t].role==="user"&&e.value.splice(t,1),v.value=null,a.value=null,V(s.value,h.value)}async function R(){if(i.value||!h.value)return;i.value=!0,m.value=!0,_.value=!1,k.value="",v.value=null;const n=e.value.length-1;n>=0&&e.value[n].role==="assistant"&&e.value.splice(n,1);const t=U("regen"),c={id:t,role:"assistant",content:"",created_at:new Date().toISOString(),isStreaming:!0,isThinking:!0};return e.value.push(c),await W(),new Promise((A,u)=>{d.regenerateStream(h.value,f=>{if(!f||f.length===0)return;m.value&&(m.value=!1,_.value=!0),k.value+=f;const S=e.value.findIndex(M=>M.id===t);S!==-1&&(e.value[S]={...e.value[S],content:k.value,isThinking:!1,isStreaming:!0})},f=>{m.value=!1,_.value=!1,i.value=!1;const S=e.value.findIndex(o=>o.id===t);if(S!==-1&&(e.value[S].id=f.message_id,e.value[S].isStreaming=!1,e.value[S].isThinking=!1),f.conversation&&(E.value=f.conversation),f.tokens_input!==void 0&&f.tokens_output!==void 0){const o=Y(f.model,f.tokens_input,f.tokens_output);l.value={input:f.tokens_input,output:f.tokens_output,model:f.model,cost:o}}j().updateTokensBalance(f.tokens_balance),A(f)},f=>{m.value=!1,_.value=!1,i.value=!1;const S=f.message||"Error al regenerar la respuesta";v.value=S;const M=e.value.findIndex(o=>o.id===t);M!==-1&&(e.value[M].isStreaming=!1,e.value[M].isThinking=!1,e.value[M].isFailed=!0,e.value[M].errorMessage=S,e.value[M].content=k.value||""),a.value=t,u(new Error(S))})})}function z(){return a.value!==null||e.value.some(n=>n.isFailed||n.isStopped)}async function K(n,t=null){if(!n.trim()||i.value)return;const c=t||h.value;i.value=!0,v.value=null,C.value=!1;const A={id:U("user"),role:"user",content:n.trim(),created_at:new Date().toISOString()};e.value.push(A);try{let u;return c?u=await d.sendConversationMessage(c,n.trim()):u=await d.sendMessage(n.trim()),e.value.push(u.data.message),u.data.conversation&&(E.value=u.data.conversation,h.value=u.data.conversation.id),j().updateTokensBalance(u.data.tokens_balance),u.data}catch(u){throw e.value=e.value.filter(f=>f.id!==A.id),u.response?.status===403&&u.response?.data?.error==="free_plan"?(w.value=!0,b.value=u.response.data,v.value=u.response.data.message):u.response?.status===402?(C.value=!0,T.value=u.response.data,v.value=u.response.data.message):v.value=u.response?.data?.message||"Error al enviar el mensaje",u}finally{i.value=!1}}async function V(n,t=null){if(!n.trim()||i.value)return;const c=t||h.value;if(!c)return K(n,t);i.value=!0,m.value=!0,_.value=!1,k.value="",v.value=null,C.value=!1,w.value=!1,a.value=null,s.value=n.trim();const A={id:U("user"),role:"user",content:n.trim(),created_at:new Date().toISOString()};e.value.push(A);const u=U("assistant"),f={id:u,role:"assistant",content:"",created_at:new Date().toISOString(),isStreaming:!0,isThinking:!0};return e.value.push(f),await W(),new Promise((S,M)=>{d.sendConversationMessageStream(c,n.trim(),o=>{if(!o||o.length===0)return;m.value&&(m.value=!1,_.value=!0),k.value+=o;const y=e.value.findIndex(p=>p.id===u);y!==-1&&(e.value[y]={...e.value[y],content:k.value,isThinking:!1,isStreaming:!0})},o=>{m.value=!1,_.value=!1,i.value=!1;const y=e.value.findIndex(F=>F.id===u);if(y!==-1&&(e.value[y].id=o.message_id,e.value[y].isStreaming=!1,e.value[y].isThinking=!1),o.conversation&&(E.value=o.conversation,ne().updateConversationLocally(o.conversation.id,{title:o.conversation.title,message_count:(E.value.message_count||0)+1,last_message_at:new Date().toISOString()})),o.tokens_input!==void 0&&o.tokens_output!==void 0){const F=Y(o.model,o.tokens_input,o.tokens_output);l.value={input:o.tokens_input,output:o.tokens_output,model:o.model,cost:F}}j().updateTokensBalance(o.tokens_balance),S(o)},o=>{m.value=!1,_.value=!1,i.value=!1;const y=o.message||"Error al enviar el mensaje";if(y==="free_plan")w.value=!0,v.value="Plan gratuito no permite chat",e.value=e.value.filter(p=>p.id!==A.id&&p.id!==u);else if(y==="tokens_exhausted")C.value=!0,v.value="Tokens agotados",e.value=e.value.filter(p=>p.id!==A.id&&p.id!==u);else{v.value=y;const p=e.value.findIndex(F=>F.id===u);p!==-1&&(e.value[p].isStreaming=!1,e.value[p].isThinking=!1,e.value[p].isFailed=!0,e.value[p].errorMessage=y,e.value[p].content=k.value||""),a.value=u}M(new Error(y))})})}async function q(n=null){const t=n||h.value;g.value=!0,v.value=null;try{return t?await d.clearConversationMessages(t):await d.clearHistory(),e.value=[],!0}catch(c){throw v.value=c.response?.data?.message||"Error al limpiar el historial",c}finally{g.value=!1}}async function ee(n){h.value=n,e.value=[],await B(n)}function te(){h.value=null,E.value=null,e.value=[]}function ae(){v.value=null,C.value=!1,T.value=null,w.value=!1,b.value=null}return{messages:e,isLoading:g,isSending:i,error:v,tokensExhausted:C,tokensExhaustedData:T,freePlanBlocked:w,freePlanData:b,hasMessages:$,streamingContent:k,isStreaming:_,isThinking:m,lastFailedMessageId:a,lastMessageTokens:l,currentAssistant:x,availableAssistants:D,isChangingAssistant:P,currentConversationId:h,currentConversation:E,fetchMessages:B,sendMessage:K,sendMessageStream:V,stopStreaming:I,retryLastMessage:H,regenerateResponse:R,canRetry:z,clearHistory:q,clearError:ae,fetchAvailableAssistants:G,changeAssistant:Q,setCurrentConversation:ee,clearCurrentConversation:te}});export{le as a,ne as u};
